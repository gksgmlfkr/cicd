<!DOCTYPE html>

<html layout:decorate="~{layout}">
<div layout:fragment="content">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    .title_line_text {
      font-size: 14px;
    }

    ul {
      padding-left: 0;
      list-style-type: none;
    }

    li {
      margin-left: 0;
      padding-left: 0;
    }

    span,
    div {
      font-size: 14px;
    }

    .table-striped img {
      width: 60px;
      height: 45px;
    }

    .table-striped .td_left {
      font-size: 14px;
    }

    .table-striped th,
    .table-striped td {
      padding: 5px;
    }

    .table-striped th {
      font-size: 14px;
    }

    .table-striped .td_basic {
      vertical-align: top;
    }

    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      /* 16:9 aspect ratio */
      height: 0;
      overflow: hidden;
      max-width: 100%;
      background: #000;
    }

    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .author-label {
      background-color: #007bff;
      /* Blue background for author label */
      color: white;
      /* White text color for author label */
      padding: 3px 8px;
      /* Padding to make the label larger */
      padding-bottom: 1px;
      border-radius: 15px;
      /* Large border-radius for rounded shape */
      font-size: 0.9em;
      margin-left: 5px;
      display: inline-block;
    }

    .like-button {
      text-align: center;
    }

    .button-like {
      background-color: transparent;
      border: none;
      color: black;
      font-size: 25px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.3s;
      /* 아이콘에 적용할 transition */
    }

    .button-like:focus {
      outline: none;
    }

    .button-like.liked #likeIcon {
      color: dodgerblue;
    }

    #likeIcon {
      transition: color 0.3s;
      /* 아이콘에 직접 transition 적용 */
    }

    #likeText {
      margin-left: 10px;
      font-size: 15px;
      transition: color 0.3s;
    }

    .button-like.liked #likeText {
      color: dodgerblue;
    }
  </style>
  <script>

    function showModal(message) {
      document.getElementById("modalBody").innerText = message; // 모달창 내용 설정
      $('#warningModal').modal('show'); // 모달창 표시
    }

    function showModal2(message) {
      document.getElementById("modalBody2").innerText = message; // 모달창 내용 설정
      $('#warningModal2').modal('show'); // 모달창 표시
    }

    function showModal3(message) {
      document.getElementById("modalBody3").innerText = message; // 모달창 내용 설정
      $('#warningModal3').modal('show'); // 모달창 표시
    }

    function deleteModal(no) {
      showModal3()
    }

    function checkID() {

      let url = './check_login'
      fetch(url, {
        method: 'GET',
        // headers: {
        //   'Content-Type': 'application/json' // JSON 형식으로 데이터 전송을 알림
        // },
        // body: JSON.stringify(dataToSend) // JSON 데이터를 문자열로 변환하여 요청 본문에 포함            
      })
        .then(response => response.json())
        .then(rdata => {
          if (rdata.check == 0) { // 로그인 X
            alert("로그인 후 추천 가능합니다.")
          }
        })
        .catch(error => { // 서버 다운등 통신 에러
          console.error('Error:', error);
        });

    }



  </script>
  <div class='title_line'>
    <span th:text="${cateVO.name }" class="title_line_text"></span>
    > <span th:text="${cateVO.namesub}" class="title_line_text"></span>
    > 글 조회
  </div>
  <aside class="aside_right">
    <a th:href="@{|/contents/list_cate?cateno=${cateVO.cateno}&word=${word}&now_page=${now_page}|}">목록</a>
    <span class='menu_divide'>│</span>
    <span th:if="${(session.memberno == contentsVO.memberno) }">
      <a th:href="@{|/contents/create?cateno=${cateVO.cateno}|}">등록</a>
      <span class='menu_divide'>│</span>
      <a
        th:href="@{|/contents/youtube?cateno=${cateVO.cateno }&contentsno=${contentsVO.contentsno}&word=${word}&now_page=${now_page}|}">Youtube</a>
      <span class='menu_divide'>│</span>
      <a th:href="@{|/contents/update_text?contentsno=${contentsVO.contentsno}&word=${word}&now_page=${now_page}|}">글
        수정</a>
      <span class='menu_divide'>│</span>
      <a th:href="@{|/contents/update_file?contentsno=${contentsVO.contentsno}&word=${word}&now_page=${now_page}|}">파일
        수정</a>
      <span class='menu_divide'>│</span>
      <a
        th:href="@{|/contents/delete?contentsno=${contentsVO.contentsno}&cateno=${cateVO.cateno}&word=${word}&now_page=${now_page}|}">삭제</a>
      <span class='menu_divide'>│</span>
    </span>
    <a href="javascript:location.reload();">새로고침</a>
  </aside>
  <!-- 
  <aside class="aside_right" th:if="${session.grade != 'admin'}">
    <a href="javascript:location.reload();">새로고침</a>
    <span class='menu_divide' >│</span>    
    <a th:href="@{|/contents/list_by_cateno?cateno=${cateVO.cateno }&word=${word }&now_page=${now_page}|}">목록형</a>    
    <span class='menu_divide' >│</span>
    <a th:href="@{|/contents/list_by_cateno_grid?cateno=${cateVO.cateno }&now_page=${now_page}&word=${word }|}">갤러리형</a>
  </aside> -->




  <div class='menu_line'></div>

  <fieldset class="fieldset_basic">
    <ul>
      <li class="li_none">
        <div style="width: 100%; word-break: break-all;">

          <span style="font-size: 1.5em; font-weight: bold;" th:text="${contentsVO.title}"></span>
          <span style="font-size: 1em; float:right; margin-top:7px;" th:text="${contentsVO.rdate}"></span><br>

          <span th:if="${contentsVO.thumbs != null}">
            <span
              th:if="${contentsVO.thumbs.endsWith('jpg') or contentsVO.thumbs.endsWith('png') or contentsVO.thumbs.endsWith('gif')}">
              <img th:src="@{|/member/storage/${contentsVO.thumbs}|}"
                style='width: 25px; height: 25px; border-radius: 50%;'>
            </span>
          </span>

          <span th:if="${contentsVO.thumbs == null}">
            <img src='/images/none.jpg ' style='width: 25px; height: 25px; border-radius: 50%;'>
          </span>

          <span th:if="${contentsVO.nickname != null}">
            <span style="font-size: 1em; margin-top: 10px; margin-bottom: 7px; display: inline-block;"
              th:text="${contentsVO.nickname}"></span>
          </span>

          <span th:if="${contentsVO.nickname == null}">
            <span style="font-size: 1em; margin-top: 10px; margin-bottom: 7px; display: inline-block;"
              th:text="${contentsVO.id}"></span>
          </span>
          <span style="color:darkgray">&nbsp;조회수&nbsp;</span><span th:text="${contentsVO.viewcnt}"></span>
          <span style="color:darkgray">&nbsp;추천수&nbsp;</span><span th:text="${contentsVO.recom}"></span>
          <span style="color:darkgray">&nbsp;댓글&nbsp;</span><span th:text="${contentsVO.commentcnt}"></span>

          <hr style="border: 0; border-top: 1px solid black; margin-top:5px;"> <!-- 글 제목/내용 나누는 부분 -->

        </div>
        <div style="width: 100%; word-break: break-all;">
          <div
            th:if="${contentsVO.file1.endsWith('jpg') or contentsVO.file1.endsWith('png') or contentsVO.file1.endsWith('gif')}">
            <img th:src="@{|/contents/storage/${contentsVO.file1saved}|}"
              style="width: 100%; height: auto; display: block; margin-top: 0.5%; margin-bottom: 1%;">
          </div>
          <div style="white-space: pre-wrap;"><span th:text="${contentsVO.content}"></span></div>
        </div>
      </li>

      <li class="li_none" style="clear: both; padding-top: 10px; padding-bottom: 25px;"
        th:if="${contentsVO.youtube.length() > 0}">
        <div style='text-align: center; width:640px; margin: 0px auto;' class="video-container"
          th:utext="${contentsVO.youtube}">
        </div>

      </li>

      <!--
      <li class="li_none" style="clear: both; padding-top: 10px; padding-bottom: 25px;">
        <span th:if="${session.memberno != null}">
          <button id="recom" type="button"
            th:attr="onclick=|location.href='/contents/recom?contentsno=${contentsVO.contentsno}&word=${word}&now_page=${now_page}'|"
            class="btn btn-secondary btn-sm">추천</button>
        </span>

        <span th:unless="${session.memberno != null}">
          <button id="recom" type="button" onclick="checkID()" class="btn btn-secondary btn-sm">추천</button>
        </span>
      </li>
-->
      <li class="li_none" style="clear: both;">
        <span style="color:dimgray" th:text="|태그(키워드): ${contentsVO.tag}|"></span>

        <div class="like-button">
          <button id="likeButton" class="button-like">
            <i id="likeIcon" class="far fa-thumbs-up"></i>
            <span id="likeText">추천</span>
          </button>
        </div>
      </li>



      <li class="li_none" th:if="${contentsVO.size1 > 0}">
        <div>
          <!-- ServletRegister.java: registrationBean.addUrlMappings("/download"); -->
          첨부 파일: <a
            th:href='@{|/download?dir=/contents/storage&filename=${contentsVO.file1saved}&downname=${contentsVO.file1}|}'
            th:text="|${contentsVO.file1}|"></a> <span th:text="|(${contentsVO.size1_label})|"></span>
        </div>
      </li>
      <li class="li_none">
        <!-- ------------------------------ 댓글 영역 시작 ------------------------------ -->
        <script>
          let sw = 0;

          window.onload = () => {

            let contents_tag = document.getElementById('contents');
            let btn_create_tag = document.getElementById('btn_create');

            contents_tag.addEventListener('click', () => {
              let id = '[[${session.id}]]'; //  JavaScript -> Thymeleaf -> Session
              //alert('Click: ' + id);
              if (id == '') {
                showModal('로그인 후 댓글 입력 가능합니다.');

              } else {

              }
            });

            btn_create_tag.addEventListener('click', () => {
              let contents = document.getElementById('contents').value;

              if (contents.trim().length == 0) {
                alert('댓글의 내용이 없습니다. 내용을 입력 해주세요.');
              } else {
                //alert('contents: ' + contents_tag.value); // 댓글 내용 출력
                fetch("/comments/create", {
                  "method": "post",
                  "headers": {"Content-Type": "application/json"},
                  body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]", "contents": contents}),
                  credentials: "include"
                })
                  .then((response) => response.json())
                  .then((data) => {
                    //list_by_contentsno_join(); // 목록 출력
                    //result_tag.value = data['res'];
                    //result_animation_tag.innerHTML = '';
                  });

                //result_animation_tag.innerHTML = '<img src="/static/images/progress.gif" style="width: 15%; margin-top: 0px;">';
              }

            });

            document.getElementById('modalConfirmButton').addEventListener('click', () => { // 로그인 필요 모달창
              location.href = "/member/login?url=contents/read?contentsno=[[${contentsVO.contentsno}]]%26word=[[${word}]]%26now_page=[[${now_page}]]";
              $('#warningModal').modal('hide'); // 모달창 닫기
            });

            document.getElementById('modalConfirmButton2').addEventListener('click', () => { // 댓글 및 답글 수정 모달창

              $('#warningModal2').modal('hide'); // 모달창 닫기
            });



            //---------------------------------------------- 추천 기능 부분 -------------------------------------------------------
            document.getElementById('likeButton').addEventListener('click', function () {
              const button = document.getElementById('likeButton');
              const icon = document.getElementById('likeIcon');

              let id = '[[${session.id}]]'; //  JavaScript -> Thymeleaf -> Session
              //alert('Click: ' + id);
              if (id == '') {
                showModal('로그인 후 추천 가능합니다.');

              }

              fetch("/recom/read?contentsno=[[${contentsVO.contentsno}]]", {
                "method": "get" // get 방식은 header 와 body 불필요
              })
                .then((response) => response.json())
                .then((data) => {
                  let row = data['res'];

                  if (row == 0) {
                    button.classList.add('liked');
                    icon.classList.remove('far');
                    icon.classList.add('fas');

                    fetch("/recom/create", {
                      "method": "post",
                      "headers": {"Content-Type": "application/json"},
                      body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]"}),
                      credentials: "include"
                    })
                      .then((response) => response.json())
                      .then((data) => {

                      });

                  } else if (row != 0) {

                    fetch("/recom/check?contentsno=[[${contentsVO.contentsno}]]", {
                      "method": "get" // get 방식은 header 와 body 불필요
                    })
                      .then((response) => response.json())
                      .then((data) => {

                        let recom = data['res']['recom'];

                        if (recom == 1) {
                          button.classList.remove('liked');
                          icon.classList.remove('fas');
                          icon.classList.add('far');

                          fetch("/recom/decrease", {
                            "method": "post",
                            "headers": {"Content-Type": "application/json"},
                            body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]", "memberno": "[[${session.memberno}]]"}),
                            credentials: "include"
                          })
                            .then((response) => response.json())
                            .then((data) => {
                              let decrease_row = data['res'];


                            });
                        } else if (recom == 0) {
                          button.classList.add('liked');
                          icon.classList.remove('far');
                          icon.classList.add('fas');

                          fetch("/recom/increase", {
                            "method": "post",
                            "headers": {"Content-Type": "application/json"},
                            body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]", "memberno": "[[${session.memberno}]]"}),
                            credentials: "include"
                          })
                            .then((response) => response.json())
                            .then((data) => {

                            });
                        }

                      });
                  }

                });

            });
            //---------------------------------------------- 추천 기능 부분 종료 -------------------------------------------------------

            list_by_contentsno_join(); // 목록 출력

            let id = '[[${session.id}]]'; //  JavaScript -> Thymeleaf -> Session
            if (id != '') {
              recom_form();
            }



          } //----------------------- window.onload() 종료 -----------------------------

          function recom_form() { // 추천 폼
            const button = document.getElementById('likeButton');
            const icon = document.getElementById('likeIcon');
            fetch("/recom/read?contentsno=[[${contentsVO.contentsno}]]", {
              "method": "get" // get 방식은 header 와 body 불필요
            })
              .then((response) => response.json())
              .then((data) => {
                let row = data['res'];

                if (row != 0) {
                  fetch("/recom/check?contentsno=[[${contentsVO.contentsno}]]", {
                    "method": "get" // get 방식은 header 와 body 불필요
                  })
                    .then((response) => response.json())
                    .then((data) => {
                      let recom = data['res']['recom'];

                      if (recom == 1) {

                        button.classList.add('liked');
                        icon.classList.remove('far');
                        icon.classList.add('fas');

                      } else if (recom == 0) {
                        button.classList.remove('liked');
                        icon.classList.remove('fas');
                        icon.classList.add('far');

                      }
                    });
                }
              });
          }

          //------------------------------------------ 댓글 관련 함수 시작---------------------------------------------------

          function list_by_contentsno_join() { // 댓글 목록 출력
            let cnt = 0; // 댓글 출력 순환 횟수
            let comment_page = 1;
            let btn_add_tag = document.getElementById("btn_add");

            fetch("/comments/list_by_contentsno_join?contentsno=[[${contentsVO.contentsno}]]", {
              "method": "get" // get 방식은 header 와 body 불필요
            })
              .then((response) => response.json())
              .then((data) => {
                //alert('res: ' + data['res']);
                //result_tag.value = data['res'];
                //result_animation_tag.innerHTML = '';
                let msg = '';
                let comments_data = data['res'];
                if (comments_data.length > 5) {
                  cnt = 5;
                  btn_add_tag.style.display = '';
                } else {
                  cnt = comments_data.length;
                  btn_add_tag.style.display = 'none';
                }

                for (let i = 0; i < cnt; i++) {
                  let row = data['res'][i];

                  // 시간을 연도, 월, 일, 시간, 분, 초 단위로 나누는 부분
                  let [datePart, timePart] = row.rdate.split(' ');
                  let [year, month, day] = datePart.split('-');
                  let [hour, minute, second] = timePart.split(':');
                  let postDate = new Date(year, month - 1, day, hour, minute, second);

                  msg += "<div id='comments" + row.commentsno + "' style='border-bottom: solid 1px #EEEEEE; margin-bottom: 10px; text-align:left;'>";
                  // 프로필 사진 출력 코드 들어갈 부분
                  if (row.thumbs != "none") {
                    if (row.thumbs.endsWith('jpg') || row.thumbs.endsWith('png') || row.thumbs.endsWith('gif')) {
                      msg += "<img src='/member/storage/" + row.thumbs + "' style='width: 25px; height: 25px; border-radius: 50%;'>";
                    }
                  }

                  if (row.thumbs == "none") {
                    msg += "<img src='/images/none.jpg ' style='width: 25px; height: 25px; border-radius: 50%;'>";
                  }

                  if (row.nickname == null) {
                    msg += "<span style='font-weight: bold;'>&nbsp;&nbsp;" + row.id + "</span>";
                  } else {
                    msg += "<span style='font-weight: bold;'>&nbsp;&nbsp;" + row.nickname + "</span>";
                  }

                  if ("[[${contentsVO.memberno}]]" == row.memberno) {
                    msg += "<span class='author-label'>작성자" + "</span>";
                  }

                  msg += "<span id='comments_date" + row.commentsno + "'>&nbsp;&nbsp;&nbsp;" + timeSince(postDate) + "</span>"; // 시간 표시 부분

                  if ('[[${session.memberno}]]' == row.memberno) { // 글쓴이 일치여부 확인, 본인의 글만 삭제 가능함 ★
                    msg += " <a href='javascript:comments_update_form(" + row.commentsno + ")'>" + "수정" + "</a>";
                    msg += " <a href='javascript:comments_delete(" + row.commentsno + ")'>" + "삭제" + "</a>";
                  }
                  msg += "  " + "<br>";
                  msg += "<span style='display: inline-block; margin-top:10px;'>" + row.contents + "</span> <br><br>";

                  //대댓글 관련
                  msg += "<button type = 'button' id='reply_list_btn" + row.commentsno + "' onclick='list_by_commentsno_join(" + row.commentsno + ")' style='border:none;'>" + "답글";
                  msg += row.replycnt + "개" + "</button>";
                  msg += "<button type = 'button' id='reply_list_cancel_btn" + row.commentsno + "' onclick='reply_list_view(" + row.commentsno + ")' style='border:none; display:none;'>" + "답글숨기기";
                  msg += "</button>";
                  msg += "<button type = 'button' id='reply_create_form_button" + row.commentsno + "' onclick='reply_create_form(" + row.commentsno + ")' style='border:none; margin-left:20px;'>" + "답글 달기";
                  msg += "</button>";
                  msg += "<div id='reply_create_form" + row.commentsno + "' style='width: 100%; margin: 0px auto; clear:both; text-align: center;'>";
                  msg += "</div>";
                  msg += "<div id='reply_list" + row.commentsno + "' data-replypage='1' style='margin-left: 20px;'>";
                  msg += "</div>";
                  msg += "</div>";
                }

                document.getElementById('comments_list').innerHTML = msg;

                btn_add_tag.addEventListener("click", () => {

                  let start_num = 5 * comment_page;
                  let end_num = start_num + 5;

                  if (comments_data.length > 5) {

                    let msg = '';
                    let page_div = document.createElement('div'); // 글내용
                    for (let i = start_num; i < end_num; i++) { // 5 ~ 9, 10 탈출
                      if (i == comments_data.length) { // 모든 태그를 출력한 이후인지 검사
                        btn_add_tag.style.display = 'none';
                        break;
                      }

                      let row = data['res'][i];

                      // 시간을 연도, 월, 일, 시간, 분, 초 단위로 나누는 부분
                      let [datePart, timePart] = row.rdate.split(' ');
                      let [year, month, day] = datePart.split('-');
                      let [hour, minute, second] = timePart.split(':');
                      let postDate = new Date(year, month - 1, day, hour, minute, second);

                      msg += "<div id='comments" + row.commentsno + "' style='border-bottom: solid 1px #EEEEEE; margin-bottom: 10px; text-align:left;'>";
                      // 프로필 사진 출력 코드 들어갈 부분
                      if (row.thumbs != "none") {
                        if (row.thumbs.endsWith('jpg') || row.thumbs.endsWith('png') || row.thumbs.endsWith('gif')) {
                          msg += "<img src='/member/storage/" + row.thumbs + "' style='width: 25px; height: 25px; border-radius: 50%;'>";
                        }
                      }

                      if (row.thumbs == "none") {
                        msg += "<img src='/images/none.jpg ' style='width: 25px; height: 25px; border-radius: 50%;'>";
                      }

                      if (row.nickname == null) {
                        msg += "<span style='font-weight: bold;'>&nbsp;&nbsp;" + row.id + "</span>";
                      } else {
                        msg += "<span style='font-weight: bold;'>&nbsp;&nbsp;" + row.nickname + "</span>";
                      }

                      if ("[[${contentsVO.memberno}]]" == row.memberno) {
                        msg += "<span class='author-label'>작성자" + "</span>";
                      }

                      msg += "<span id='comments_date" + row.commentsno + "'>&nbsp;&nbsp;&nbsp;" + timeSince(postDate) + "</span>"; // 시간 표시 부분

                      if ('[[${session.memberno}]]' == row.memberno) { // 글쓴이 일치여부 확인, 본인의 글만 삭제 가능함 ★
                        msg += " <a href='javascript:comments_update_form(" + row.commentsno + ")'>" + "수정" + "</a>";
                        msg += " <a href='javascript:comments_delete(" + row.commentsno + ")'>" + "삭제" + "</a>";
                      }
                      msg += "  " + "<br>";
                      msg += "<span style='display: inline-block; margin-top:10px;'>" + row.contents + "</span> <br><br>";

                      //대댓글 관련
                      msg += "<button type = 'button' id='reply_list_btn" + row.commentsno + "' onclick='list_by_commentsno_join(" + row.commentsno + ")' style='border:none;'>" + "답글";
                      msg += row.replycnt + "개" + "</button>";
                      msg += "<button type = 'button' id='reply_list_cancel_btn" + row.commentsno + "' onclick='reply_list_view(" + row.commentsno + ")' style='border:none; display:none;'>" + "답글숨기기";
                      msg += "</button>";
                      msg += "<button type = 'button' id='reply_create_form_button" + row.commentsno + "' onclick='reply_create_form(" + row.commentsno + ")' style='border:none; margin-left:20px;'>" + "답글 달기";
                      msg += "</button>";
                      msg += "<div id='reply_create_form" + row.commentsno + "' style='width: 100%; margin: 0px auto; clear:both; text-align: center;'>";
                      msg += "</div>";
                      msg += "<div id='reply_list" + row.commentsno + "' data-replypage='1' style='margin-left: 20px;'>";
                      msg += "</div>";
                      msg += "</div>";

                    }
                    page_div.innerHTML = msg; //  페이지에 속한 레코드들 추가
                    document.getElementById('comments_list').appendChild(page_div);

                    comment_page = comment_page + 1;
                  }

                });

              });

          }







          function comments_update_form(no) { // 댓글 수정 폼
            let comments_tag = document.getElementById('comments' + no);
            let msg = '';
            msg += "<hr>";
            msg += "<form name='frm_reply' id='frm_reply'>";
            msg += "<input type='hidden' name='memberno' id='memberno' value=''>";
            msg += "<input type='hidden' name='commentsno' id='commentsno' value=''>";
            msg += "<textarea name='comments_update_contents" + no + "' id='comments_update_contents" + no + "' class='form-control' style='width: 100%; height: 60px;' placeholder='답글 작성, 로그인해야 등록 할 수 있습니다.'>";
            msg += "</textarea>";
            msg += "<button type='button' id='btn_reply_create' onclick='comments_update(" + no + ")'>";
            msg += "&nbsp;&nbsp;저&nbsp;&nbsp;장&nbsp;&nbsp;";
            msg += "</button>";
            msg += "<button type='button' id='btn_reply_cancel' onclick='list_by_contentsno_join()' style='margin-left:5px;'>";
            msg += "&nbsp;&nbsp;취&nbsp;&nbsp;소&nbsp;&nbsp;";
            msg += "</button>";
            msg += "</form>";
            msg += "<hr>";
            comments_tag.innerHTML = msg;

            let commentsno_tag = document.getElementById('commentsno');
            let memberno_tag = document.getElementById('memberno');
            let comments_contents_tag = document.getElementById('comments_update_contents' + no);

            fetch("/comments/read?commentsno=" + no, {
              "method": "get",
              "headers": {"Content-Type": "application/json"},
              // body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]"})
            })
              .then((response) => response.json())
              .then((data) => {
                commentsno_tag.value = data['res']['commentsno'];
                memberno_tag.value = data['res']['memberno'];
                comments_contents_tag.value = data['res']['contents'];
              });

          }


          function comments_update(no) { // 댓글 수정 처리
            let commentsno_tag = document.getElementById('commentsno');
            let memberno_tag = document.getElementById('memberno');
            let comments_contents_tag = document.getElementById('comments_update_contents' + no);

            let contents = comments_contents_tag.value;
            let memberno = memberno_tag.value;
            let commentsno = commentsno_tag.value;

            if (contents.length == 0) {
              showModal2('내용이 없습니다. 내용을 입력해주세요.');
            } else {
              fetch("/comments/update", {
                "method": "post",
                "headers": {"Content-Type": "application/json"},
                body: JSON.stringify({"commentsno": commentsno, "memberno": memberno, "contents": contents})
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data['res'] == 0) {
                    showModal2('댓글 수정에 실패했습니다.');
                  } else {
                    list_by_contentsno_join(); // 목록 출력
                  }
                });

              location.reload();

            }

          }

          function comments_delete(no) { // 댓글 삭제

            let contents_tag = document.getElementById('contents');

            fetch("/comments/read?commentsno=" + no, {
              "method": "get",
              "headers": {"Content-Type": "application/json"},
              // body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]"})
            })
              .then((response) => response.json())
              .then((data) => {
                //let sw = confirm("「" + data['res']['contents'] + "」 삭제하시려면 확인 버튼을 누르세요. 삭제후 복구 할 수 없습니다.");
                showModal3("「" + data['res']['contents'] + "」 삭제하시려면 확인 버튼을 누르세요. 삭제후 복구 할 수 없습니다.");
                console.log(sw);
                
                document.getElementById('modalConfirmButton3').addEventListener('click', () => { // 댓글 및 답글 삭제 확인버튼 모달창
                  sw = 1;
                  $('#warningModal3').modal('hide'); // 모달창 닫기

                });

                document.getElementById('modalCancelButton').addEventListener('click', () => { // 댓글 및 답글 삭제 취소버튼 모달창
                  sw = 2;
                  $('#warningModal3').modal('hide'); // 모달창 닫기

                });
                if (sw == 1) {

                  fetch("/comments/delete", {
                    "method": "post",
                    "headers": {"Content-Type": "application/json"},
                    body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]", "commentsno": no, "memberno": data['res']['memberno']})
                  })
                    .then((response) => response.json())
                    .then((data) => {

                      if (data['res'] == 1) {
                        location.reload();
                        list_by_contentsno_join(); // 목록 출력

                      } else {
                        alert('댓글 삭제에 실패했습니다. 다시 시도 해주세요.');
                      }
                    });

                } else {
                  //alert('삭제를 취소 했습니다.');
                }
              });

          }

          function timeSince(date) { // 작성일자 표시 함수
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;

            if (interval > 1) {
              return Math.floor(interval) + "년 전";
            }
            interval = seconds / 2592000;
            if (interval > 1) {
              return Math.floor(interval) + "달 전";
            }
            interval = seconds / 86400;
            if (interval > 1) {
              return Math.floor(interval) + "일 전";
            }
            interval = seconds / 3600;
            if (interval > 1) {
              return Math.floor(interval) + "시간 전";
            }
            interval = seconds / 60;
            if (interval > 1) {
              return Math.floor(interval) + "분 전";
            }
            return Math.floor(seconds) + "초 전";
          }




          //------------------------------------------ 댓글 관련 함수 종료---------------------------------------------------

          //------------------------------------------ 대댓글 관련 함수 시작---------------------------------------------------

          function list_by_commentsno_join(no) { // 대댓글 목록 출력
            let reply_list_tag = document.getElementById('reply_list' + no);
            let reply_list_btn_tag = document.getElementById('reply_list_btn' + no);
            let reply_list_cancel_btn_tag = document.getElementById('reply_list_cancel_btn' + no);

            reply_list_btn_tag.style.display = 'none';
            reply_list_cancel_btn_tag.style.display = '';
            reply_list_tag.style.display = '';

            fetch("/reply/list_by_commentsno_join?commentsno=" + no, {
              "method": "get" // get 방식은 header 와 body 불필요
            })
              .then((response) => response.json())
              .then((data) => {
                //alert('res: ' + data['res']);
                //result_tag.value = data['res'];
                //result_animation_tag.innerHTML = '';
                let msg = '';

                for (let i = 0; i < data['res_reply'].length; i++) {
                  let row = data['res_reply'][i];

                  let [datePart, timePart] = row.rdate.split(' ');
                  let [year, month, day] = datePart.split('-');
                  let [hour, minute, second] = timePart.split(':');
                  let postDate = new Date(year, month - 1, day, hour, minute, second);

                  msg += "<div id='reply" + row.replyno + "' style='border-bottom: solid 1px #EEEEEE; background-color: #f5f5dc; margin-bottom: 10px; margin-top: 5px; text-align:left;'>";

                  if (row.thumbs != null) {

                    if (row.thumbs.endsWith('jpg') || row.thumbs.endsWith('png') || row.thumbs.endsWith('gif')) {
                      msg += "<img src='/member/storage/" + row.thumbs + "' style='width: 25px; height: 25px; border-radius: 50%;'>";
                    }

                  }

                  if (row.thumbs == null) {
                    msg += "<img src='/images/none.jpg ' style='width: 25px; height: 25px; border-radius: 50%;'>";
                  }

                  if (row.nickname == null) {
                    msg += "<span style='font-weight: bold;'>&nbsp;&nbsp;" + row.id + "</span>";
                  } else {
                    msg += "<span style='font-weight: bold;'>&nbsp;&nbsp;" + row.nickname + "</span>";
                  }

                  if ("[[${contentsVO.memberno}]]" == row.memberno) {
                    msg += "<span class='author-label'>작성자" + "</span>";
                  }

                  msg += "<span id='reply_date" + row.replyno + "'>&nbsp;&nbsp;&nbsp;" + timeSince(postDate) + "</span>"; // 시간 표시 부분

                  if ('[[${session.memberno}]]' == row.memberno) { // 글쓴이 일치여부 확인, 본인의 글만 삭제 가능함 ★
                    msg += " <a href='javascript:reply_update_form(" + row.replyno + ")'>&nbsp;&nbsp;&nbsp;" + "수정" + "</a>";
                    msg += " <a href='javascript:reply_delete(" + row.replyno + ")'>&nbsp;" + "삭제" + "</a>";
                  }
                  msg += "  " + "<br>";
                  msg += "<span style='display: inline-block; margin-top:10px;'>" + row.contents + "</span> <br><br>";

                  msg += "</div>";
                }

                document.getElementById('reply_list' + no).innerHTML = msg;
              });
          }

          function reply_list_view(no) { // 대댓글 리스트 접기
            let reply_list_tag = document.getElementById('reply_list' + no);
            let reply_list_btn_tag = document.getElementById('reply_list_btn' + no);
            let reply_list_cancel_btn_tag = document.getElementById('reply_list_cancel_btn' + no);

            reply_list_tag.style.display = 'none';
            reply_list_btn_tag.style.display = '';
            reply_list_cancel_btn_tag.style.display = 'none';

          }

          function reply_check_login() {
            let id = '[[${session.id}]]'; //  JavaScript -> Thymeleaf -> Session
            //alert('Click: ' + id);
            if (id == '') {
              showModal('로그인 후 답글 입력 가능합니다.');
            } else {

            }
          }

          function reply_create_form(no) { // 대댓글 작성 폼
            let reply_create_form_tag = document.getElementById('reply_create_form' + no);
            let msg = '';
            msg += "<hr>";
            msg += "<form name='frm_reply' id='frm_reply'>";
            msg += "<textarea name='reply_contents' id='reply_contents' class='form-control' onclick='reply_check_login()' style='width: 100%; height: 60px;' placeholder='답글 작성, 로그인해야 등록 할 수 있습니다.'>";
            msg += "</textarea>";
            msg += "<button type='button' id='btn_reply_create' onclick='reply_create(" + no + ")'>";
            msg += "&nbsp;&nbsp;등&nbsp;&nbsp;록&nbsp;&nbsp;";
            msg += "</button>";
            msg += "<button type='button' id='btn_reply_cancel' onclick='reply_cancel(" + no + ")' style='margin-left:5px;'>";
            msg += "&nbsp;&nbsp;취&nbsp;&nbsp;소&nbsp;&nbsp;";
            msg += "</button>";
            msg += "</form>";
            msg += "<hr>";
            if (reply_create_form_tag.style.display == 'none') {
              reply_create_form_tag.style.display = '';
            }
            document.getElementById('reply_create_form' + no).innerHTML = msg;
          }

          function reply_create(no) { // 대댓글 작성 처리
            let reply_contents = document.getElementById('reply_contents').value;

            if (reply_contents.trim().length == 0) {
              alert('답글의 내용이 없습니다. 내용을 입력 해주세요.');
            } else {
              //alert('contents: ' + contents_tag.value); // 댓글 내용 출력
              fetch("/reply/create", {
                "method": "post",
                "headers": {"Content-Type": "application/json"},
                body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]", "commentsno": no, "contents": reply_contents}),
                credentials: "include"
              })
                .then((response) => response.json())
                .then((data) => {
                  list_by_contentsno_join(); // 목록 출력
                });

            }

            location.reload();

          }

          function reply_cancel(no) { // 대댓글 등록 취소
            let reply_create_form_tag = document.getElementById('reply_create_form' + no);
            reply_create_form_tag.style.display = 'none';
          }

          function reply_update_form(no) { // 대댓글 수정 폼
            let reply_tag = document.getElementById('reply' + no);

            let msg = '';

            fetch("/reply/read?replyno=" + no, { // 대댓글 정보 조회
              "method": "get",
              "headers": {"Content-Type": "application/json"},
              // body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]"})
            })
              .then((response) => response.json())
              .then((data) => {
                let commentsno = data['res']['commentsno']; // 댓글 번호 추출

                msg += "<hr>";
                msg += "<form name='frm_reply' id='frm_reply'>";
                msg += "<input type='hidden' name='memberno' id='memberno' value=''>";
                msg += "<input type='hidden' name='replyno' id='replyno' value=''>";
                msg += "<textarea name='reply_update_contents" + no + "' id='reply_update_contents" + no + "' class='form-control' style='width: 100%; height: 60px;' placeholder='답글 작성, 로그인해야 등록 할 수 있습니다.'>";
                msg += "</textarea>";
                msg += "<button type='button' id='btn_reply_create' onclick='reply_update(" + no + ")'>";
                msg += "&nbsp;&nbsp;저&nbsp;&nbsp;장&nbsp;&nbsp;";
                msg += "</button>";
                msg += "<button type='button' id='btn_reply_cancel' onclick='list_by_commentsno_join(" + commentsno + ")' style='margin-left:5px;'>";
                msg += "&nbsp;&nbsp;취&nbsp;&nbsp;소&nbsp;&nbsp;";
                msg += "</button>";
                msg += "</form>";
                msg += "<hr>";
                reply_tag.innerHTML = msg;

                let replyno_tag = document.getElementById('replyno');
                let memberno_tag = document.getElementById('memberno');
                let reply_update_contents_tag = document.getElementById('reply_update_contents' + no);


                replyno_tag.value = data['res']['replyno'];
                memberno_tag.value = data['res']['memberno'];
                reply_update_contents_tag.value = data['res']['contents'];
              });

          }

          function reply_update(no) { // 대댓글 수정 처리
            let replyno_tag = document.getElementById('replyno');
            let memberno_tag = document.getElementById('memberno');
            let reply_contents_tag = document.getElementById('reply_update_contents' + no);

            let contents = reply_contents_tag.value;
            let memberno = memberno_tag.value;
            let replyno = replyno_tag.value;

            if (contents.length == 0) {
              alert('내용이 없습니다. 내용을 입력해주세요.');
            } else {
              fetch("/reply/update", {
                "method": "post",
                "headers": {"Content-Type": "application/json"},
                body: JSON.stringify({"replyno": replyno, "memberno": memberno, "contents": contents})
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data['res'] == 0) {
                    alert('답글 수정에 실패 했습니다.)');
                  } else {

                    fetch("/reply/read?replyno=" + no, { // 대댓글 정보 조회
                      "method": "get",
                      "headers": {"Content-Type": "application/json"},
                      // body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]"})
                    })
                      .then((response) => response.json())
                      .then((data) => {
                        let commentsno = data['res']['commentsno']; // 댓글 번호 추출
                        list_by_commentsno_join(commentsno); // 대댓글 목록 출력
                      });

                  }

                });

            }

            location.reload();

          }

          function reply_delete(no) { // 대댓글 삭제

            let contents_tag = document.getElementById('contents');

            fetch("/reply/read?replyno=" + no, {
              "method": "get",
              "headers": {"Content-Type": "application/json"},
              // body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]"})
            })
              .then((response) => response.json())
              .then((data) => {
                let commentsno = data['res']['commentsno'];
                let memberno = data['res']['memberno'];
                let sw = confirm("「" + data['res']['contents'] + "」 삭제하시려면 확인 버튼을 누르세요. 삭제후 복구 할 수 없습니다.");
                if (sw == true) {

                  fetch("/reply/delete", {
                    "method": "post",
                    "headers": {"Content-Type": "application/json"},
                    body: JSON.stringify({"replyno": no, "memberno": memberno, "commentsno": commentsno})
                  })
                    .then((response) => response.json())
                    .then((data) => {

                      if (data['res'] == 1) {
                        list_by_commentsno_join(commentsno); // 목록 출력

                      } else {
                        alert('댓글 삭제에 실패했습니다. 다시 시도 해주세요.');
                      }
                    });

                } else {
                  alert('삭제를 취소 했습니다.');
                }
              });

            location.reload();
          }






//------------------------------------------ 대댓글 관련 함수 종료---------------------------------------------------


        </script>
        <div style='width: 100%; margin: 0px auto; clear:both; text-align: center;'>
          <hr>
          <form name='frm_comments' id='frm_comments'>

            <textarea name='contents' id='contents' class="form-control" style='width: 100%; height: 60px;'
              placeholder="댓글 작성, 로그인해야 등록 할 수 있습니다."></textarea>
            <button type='button' id='btn_create'
              onclick="javascript:location.reload()">&nbsp;&nbsp;등&nbsp;&nbsp;록&nbsp;&nbsp;</button>
          </form>
          <hr>

          <div id='comments_list' data-commentspage='1'> <!-- 목록 -->
            등록된 댓글이 없습니다.
          </div>
          <div id='comments_list_btn' style="border: none;">
            <button id='btn_add' style='width: 100%;'>더보기 ▽</button>
          </div>

        </div>

        <!-- ------------------------------ 댓글 영역 종료 ------------------------------  -->
      </li>
    </ul>
  </fieldset>

  <div class="modal fade" id="warningModal" tabindex="-1" role="dialog" aria-labelledby="warningModalLabel"
    aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="warningModalLabel">경고</h5>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- 경고 메시지가 여기에 표시됩니다 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="modalConfirmButton">확인</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="warningModal2" tabindex="-1" role="dialog" aria-labelledby="warningModalLabel"
    aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="warningModalLabel2">경고</h5>
        </div>
        <div class="modal-body" id="modalBody2">
          <!-- 경고 메시지가 여기에 표시됩니다 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="modalConfirmButton2">확인</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="warningModal3" tabindex="-1" role="dialog" aria-labelledby="warningModalLabel"
    aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="warningModalLabel3">경고</h5>
        </div>
        <div class="modal-body" id="modalBody3">
          <!-- 경고 메시지가 여기에 표시됩니다 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="modalConfirmButton3">확인</button>
          <button type="button" class="btn btn-secondary" id="modalCancelButton">취소</button>
        </div>
      </div>
    </div>
  </div>

</div>

</body>

</html>