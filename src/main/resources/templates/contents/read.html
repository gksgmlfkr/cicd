<!DOCTYPE html>
<html layout:decorate="~{layout}"> <!-- layout.html 상속-->
<div layout:fragment="content">
  <script>

    function checkID() {

      let url = './check_login'
      fetch(url, {
        method: 'GET',
        // headers: {
        //   'Content-Type': 'application/json' // JSON 형식으로 데이터 전송을 알림
        // },
        // body: JSON.stringify(dataToSend) // JSON 데이터를 문자열로 변환하여 요청 본문에 포함            
      })
        .then(response => response.json())
        .then(rdata => {
          if (rdata.check == 0) { // 로그인 X
            alert("로그인 후 추천 가능합니다.")
          }
        })
        .catch(error => { // 서버 다운등 통신 에러
          console.error('Error:', error);
        });

      // ---------------------------------------------------------------------------------------
      // fetch 관련 종료
      // ---------------------------------------------------------------------------------------

    }






  </script>
  <div class='title_line'>
    <span th:text="${cateVO.name }" class="title_line_text"></span>
    > <span th:text="${cateVO.namesub}" class="title_line_text"></span>
    > 글 조회
  </div>
  <aside class="aside_right">
    <a th:href="@{|/contents/list_cate?cateno=${cateVO.cateno}&word=${word}&now_page=${now_page}|}">목록</a>
    <span class='menu_divide'>│</span>
    <a th:href="@{|/contents/create?cateno=${cateVO.cateno}|}">등록</a>
    <span class='menu_divide'>│</span>
    <a
      th:href="@{|/contents/youtube?cateno=${cateVO.cateno }&contentsno=${contentsVO.contentsno}&word=${word}&now_page=${now_page}|}">Youtube</a>
    <span class='menu_divide'>│</span>
    <a th:href="@{|/contents/update_text?contentsno=${contentsVO.contentsno}&word=${word}&now_page=${now_page}|}">글
      수정</a>
    <span class='menu_divide'>│</span>
    <a th:href="@{|/contents/update_file?contentsno=${contentsVO.contentsno}&word=${word}&now_page=${now_page}|}">파일
      수정</a>
    <span class='menu_divide'>│</span>
    <a
      th:href="@{|/contents/delete?contentsno=${contentsVO.contentsno}&cateno=${cateVO.cateno}&word=${word}&now_page=${now_page}|}">삭제</a>
    <span class='menu_divide'>│</span>
    <a href="javascript:location.reload();">새로고침</a>
    <span class='menu_divide'>│</span>
  </aside>
  <!-- 
  <aside class="aside_right" th:if="${session.grade != 'admin'}">
    <a href="javascript:location.reload();">새로고침</a>
    <span class='menu_divide' >│</span>    
    <a th:href="@{|/contents/list_by_cateno?cateno=${cateVO.cateno }&word=${word }&now_page=${now_page}|}">목록형</a>    
    <span class='menu_divide' >│</span>
    <a th:href="@{|/contents/list_by_cateno_grid?cateno=${cateVO.cateno }&now_page=${now_page}&word=${word }|}">갤러리형</a>
  </aside> -->




  <div class='menu_line'></div>

  <fieldset class="fieldset_basic">
    <ul>
      <li class="li_none">
        <div style="width: 100%; word-break: break-all;">

          <div
            th:if="${contentsVO.file1.endsWith('jpg') or contentsVO.file1.endsWith('png') or contentsVO.file1.endsWith('gif')}">
            <img th:src="@{|/contents/storage/${contentsVO.file1saved}|}"
              style='width: 50%; float: left; margin-top: 0.5%; margin-right: 1%;'>
          </div>

          <span style="font-size: 1.5em; font-weight: bold;" th:text="${contentsVO.title}"></span>
          <span style="font-size: 1em;" th:text="${contentsVO.rdate}"></span><br><br>
          <div style="white-space: pre-wrap;"><span th:text="${contentsVO.content}"></span></div>
        </div>
      </li>

      <li class="li_none" style="clear: both; padding-top: 10px; padding-bottom: 25px;"
        th:if="${contentsVO.youtube.length() > 0}">
        <div style='text-align: center; width:640px; margin: 0px auto;' th:utext="${contentsVO.youtube}">
        </div>

      </li>

      <li class="li_none" style="clear: both; padding-top: 10px; padding-bottom: 25px;">
        <span th:if="${session.memberno != null}">
          <button id="recom" type="button"
            th:attr="onclick=|location.href='/contents/recom?contentsno=${contentsVO.contentsno}&word=${word}&now_page=${now_page}'|"
            class="btn btn-secondary btn-sm">추천</button>
        </span>

        <span th:unless="${session.memberno != null}">
          <button id="recom" type="button" onclick="checkID()" class="btn btn-secondary btn-sm">추천</button>
        </span>
      </li>

      <li class="li_none" style="clear: both;" th:text="|태그(키워드): ${contentsVO.tag}|">
      </li>

      <li class="li_none" th:if="${contentsVO.size1 > 0}">
        <div>
          <!-- ServletRegister.java: registrationBean.addUrlMappings("/download"); -->
          첨부 파일: <a
            th:href='@{|/download?dir=/contents/storage&filename=${contentsVO.file1saved}&downname=${contentsVO.file1}|}'
            th:text="|${contentsVO.file1}|"></a> <span th:text="|(${contentsVO.size1_label})|"></span>
        </div>
      </li>
      <li class="li_none">
        <!-- ------------------------------ 댓글 영역 시작 ------------------------------ -->
        <script>
          window.onload = () => {
            let contents_tag = document.getElementById('contents');
            let btn_create_tag = document.getElementById('btn_create');

            contents_tag.addEventListener('click', () => {
              let id = '[[${session.id}]]'; //  JavaScript -> Thymeleaf -> Session
              //alert('Click: ' + id);
              if (id == '') {
                alert('로그인 후 댓글 입력 가능합니다.');
                location.href = "/member/login?url=contents/read?contentsno=[[${contentsVO.contentsno}]]%26word=[[${word}]]%26now_page=[[${now_page}]]";
              } else {

              }
            });

            btn_create_tag.addEventListener('click', () => {
              let contents = document.getElementById('contents').value;

              if (contents.trim().length == 0) {
                alert('댓글의 내용이 없습니다. 내용을 입력 해주세요.');
              } else {
                //alert('contents: ' + contents_tag.value); // 댓글 내용 출력
                fetch("/comments/create", {
                  "method": "post",
                  "headers": {"Content-Type": "application/json"},
                  body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]", "contents": contents}),
                  credentials: "include"
                })
                  .then((response) => response.json())
                  .then((data) => {
                    //list_by_contentsno_join(); // 목록 출력
                    //result_tag.value = data['res'];
                    //result_animation_tag.innerHTML = '';
                  });

                //result_animation_tag.innerHTML = '<img src="/static/images/progress.gif" style="width: 15%; margin-top: 0px;">';
              }

            });
            list_by_contentsno_join(); // 목록 출력

          }

          function list_by_contentsno_join() { // 목록 출력
            fetch("/comments/list_by_contentsno_join?contentsno=[[${contentsVO.contentsno}]]", {
              "method": "get" // get 방식은 header 와 body 불필요
            })
              .then((response) => response.json())
              .then((data) => {
                //alert('res: ' + data['res']);
                //result_tag.value = data['res'];
                //result_animation_tag.innerHTML = '';
                let msg = '';
                for (let i = 0; i < data['res'].length; i++) {
                  let row = data['res'][i];

                  msg += "<div id='" + row.commentsno + "' style='border-bottom: solid 1px #EEEEEE; margin-bottom: 10px; text-align:left;'>";
                  msg += "<span style='font-weight: bold;'>" + row.id + "</span>";
                  msg += "  " + row.rdate;

                  if ('[[${session.memberno}]]' == row.memberno) { // 글쓴이 일치여부 확인, 본인의 글만 삭제 가능함 ★
                    msg += " <a href='javascript:reply_update(" + row.commentsno + ")'><img src='/reply/images/update.png'></a>";
                    msg += " <a href='javascript:reply_delete(" + row.commentsno + ")'><img src='/reply/images/delete.png'></a>";
                  }
                  msg += "  " + "<br>";
                  msg += row.contents + "<br><br>";

                  //대댓글 목록 시작
                  //      msg += "<button type = 'button' id='reply_list_btn'" + row.commentsno + "' style='border:none;'>" + "답글" + "    ";
                  msg += "<button type = 'button' id='reply_list_btn" + row.commentsno + "' onclick='list_by_commentsno_join(" + row.commentsno + ")' style='border:none;'>" + "답글";
                  msg += row.replycnt + "개" + "</button>";
                  msg += "<button type = 'button' id='reply_create_form_button" + row.commentsno + "' onclick='reply_create_form(" + row.commentsno + ")' style='border:none; margin-left:20px;'>" + "답글 달기";
                  msg += "</button>";
                  msg += "<div id='reply_create_form" + row.commentsno + "' style='width: 100%; margin: 0px auto; clear:both; text-align: center;'>";
                  msg += "</div>";
                  msg += "<div id='reply_list" + row.commentsno + "' data-replypage='1' style='margin-left: 20px;'>";
                  msg += "</div>";
                  msg += "</div>";
                }

                document.getElementById('comments_list').innerHTML = msg;
              });


          }

          function list_by_commentsno_join(no) { // 대댓글 목록 출력

            fetch("/reply/list_by_commentsno_join?commentsno=" + no, {
              "method": "get" // get 방식은 header 와 body 불필요
            })
              .then((response) => response.json())
              .then((data) => {
                //alert('res: ' + data['res']);
                //result_tag.value = data['res'];
                //result_animation_tag.innerHTML = '';
                let msg = '';

                for (let i = 0; i < data['res_reply'].length; i++) {
                  let row = data['res_reply'][i];

                  msg += "<div id='" + row.replyno + "' style='border-bottom: solid 1px #EEEEEE; margin-bottom: 10px; text-align:left;'>";
                  msg += "<span style='font-weight: bold;'>" + row.id + "</span>";
                  msg += "  " + row.rdate;

                  if ('[[${session.memberno}]]' == row.memberno) { // 글쓴이 일치여부 확인, 본인의 글만 삭제 가능함 ★
                    msg += " <a href='javascript:reply_update(" + row.replyno + ")'><img src='/reply/images/update.png'></a>";
                    msg += " <a href='javascript:reply_delete(" + row.replyno + ")'><img src='/reply/images/delete.png'></a>";
                  }
                  msg += "  " + "<br>";
                  msg += row.contents + "<br><br>";

                  msg += "</div>";
                }

                document.getElementById('reply_list' + no).innerHTML = msg;
              });
          }

          function reply_create_form(no) { // 대댓글 작성 폼
            
            btn_create_tag.addEventListener('click', () => {
              let contents = document.getElementById('contents').value;

              if (contents.trim().length == 0) {
                alert('댓글의 내용이 없습니다. 내용을 입력 해주세요.');
              } else {
                //alert('contents: ' + contents_tag.value); // 댓글 내용 출력
                fetch("/comments/create", {
                  "method": "post",
                  "headers": {"Content-Type": "application/json"},
                  body: JSON.stringify({"contentsno": "[[${contentsVO.contentsno}]]", "contents": contents}),
                  credentials: "include"
                })
                  .then((response) => response.json())
                  .then((data) => {
                    //list_by_contentsno_join(); // 목록 출력
                    //result_tag.value = data['res'];
                    //result_animation_tag.innerHTML = '';
                  });

                //result_animation_tag.innerHTML = '<img src="/static/images/progress.gif" style="width: 15%; margin-top: 0px;">';
              }

            });
            let msg = '';
            msg += "<hr>";
            msg += "<form name='frm_reply' id='frm_reply'>";
            msg += "<textarea name='contents' id='contents' class='form-control' style='width: 100%; height: 60px;' placeholder='댓글 작성, 로그인해야 등록 할 수 있습니다.'>";
            msg += "</textarea>";
            msg += "<button type='button' id='btn_reply_create' onclick='javascript:location.reload()'>";
            msg += "&nbsp;&nbsp;등&nbsp;&nbsp;록&nbsp;&nbsp;";
            msg += "</button>";
            msg += "</form>";
            msg += "<hr>";

            document.getElementById('reply_create_form' + no).innerHTML = msg;
          }



        </script>
        <div style='width: 100%; margin: 0px auto; clear:both; text-align: center;'>
          <hr>
          <form name='frm_comments' id='frm_comments'>

            <textarea name='contents' id='contents' class="form-control" style='width: 100%; height: 60px;'
              placeholder="댓글 작성, 로그인해야 등록 할 수 있습니다."></textarea>
            <button type='button' id='btn_create'
              onclick="javascript:location.reload()">&nbsp;&nbsp;등&nbsp;&nbsp;록&nbsp;&nbsp;</button>
          </form>
          <hr>

          <div id='comments_list' data-commentspage='1'> <!-- 목록 -->
            등록된 댓글이 없습니다.
          </div>
          <div id='comments_list_btn' style="border: none;">
            <button id='btn_add' style='width: 100%;'>더보기 ▽</button>
          </div>

        </div>

        <!-- ------------------------------ 댓글 영역 종료 ------------------------------  -->
      </li>
    </ul>
  </fieldset>

</div>

</body>

</html>