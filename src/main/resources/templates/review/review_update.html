<html layout:decorate="~{layout}">
<!-- layout.html 상속 -->
<div layout:fragment="content" style="width: 80%; margin: 50px auto; text-align: center;">
  <div th:fragment="comments_fragment">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"></script>
<style>
      /* 기본 스타일 */
      body {
        font-family: Arial, sans-serif;
        /* 글꼴 설정 */
        margin: 20px;
        /* 바깥 여백 설정 */
      }

      .comment-section {
        width: 60%;
        /* 섹션 너비 설정 */
        display: flex;
        /* Flexbox 사용 */
        flex-direction: column;
        /* Flexbox 방향을 세로로 설정 */
        align-items: center;
        /* 항목을 중앙 정렬 */
        margin: 0 auto;
        /* 중앙에 배치 */
      }

      .submit-button {
        padding: 10px 20px;
        /* 안쪽 여백 설정 */
        background-color: #4CAF50;
        /* 배경색 설정 */
        color: white;
        /* 글자색 설정 */
        border: none;
        /* 테두리 없음 */
        border-radius: 4px;
        /* 모서리 둥글게 */
        cursor: pointer;
        /* 커서 모양 변경 */
        font-size: 16px;
        /* 글자 크기 설정 */
      }

      .submit-button:hover {
        background-color: #45a049;
        /* 마우스 오버 시 배경색 변경 */
      }

      /* 별점 */
      .star-rating {
        direction: ltr;
        /* 왼쪽에서 오른쪽으로 표시 */
        display: flex;
        /* Flexbox 사용 */
        flex-direction: row-reverse;
        /* 항목을 오른쪽에서 왼쪽으로 표시 */
        justify-content: center;
        /* 중앙 정렬 */
        margin-bottom: 10px;
        /* 아래쪽 여백 설정 */
      }

      .star-rating input[type="radio"] {
        display: none;
        /* 라디오 버튼 숨김 */
      }

      .star-rating label {
        font-size: 2rem;
        /* 글자 크기 설정 */
        color: #ddd;
        /* 기본 별 색상 */
        cursor: pointer;
        /* 커서 모양 변경 */
      }

      .star-rating input[type="radio"]:checked~label {
        color: #f5b301;
        /* 선택된 별 색상 */
      }

      .star-rating label:hover,
      .star-rating label:hover~label {
        color: #f5b301;
        /* 마우스 오버 시 별 색상 */
      }

      /* 입력폼 */
      textarea {
        width: 100%;
        /* 너비 설정 */
        margin-bottom: 10px;
        /* 아래쪽 여백 설정 */
      }

      h4 {
        margin-bottom: 10px;
        /* 아래쪽 여백 설정 */
      }
    </style>

    <form name='frm' method='post' action='/review/review_update_proc' onsubmit="return validateForm()">
      <div class="comment-section">
          <h4>리뷰 수정</h4> <span th:text="|${memberVO.mname}  님|"></span>
          <input type="hidden" id="reviewno" name="reviewno" th:value="${reviewVO.reviewno }">
          <!-- Star Rating Section -->
          <div class="star-rating">
            <input type="radio" id="star5" name="star" value="5"><label for="star5">★</label>
            <input type="radio" id="star4" name="star" value="4"><label for="star4">★</label>
            <input type="radio" id="star3" name="star" value="3"><label for="star3">★</label>
            <input type="radio" id="star2" name="star" value="2"><label for="star2">★</label>
            <input type="radio" id="star1" name="star" value="1"><label for="star1">★</label>
          </div>
  
          <textarea id="comments" name="contents" class="comments-input" rows="4"
            placeholder="여기에 리뷰를 입력하세요..." th:text="${reviewVO.contents}"></textarea>
          <button type="submit" class="submit-button">리뷰 작성</button>
      </div>
    </form>
    
     <!-- 모달창 -->
    <div class="modal fade" id="warningModal" tabindex="-1" role="dialog" aria-labelledby="warningModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="warningModalLabel">경고</h5>
          </div>
          <div class="modal-body" id="modalBody">
            <!-- 경고 메시지가 여기에 표시됩니다 -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">확인</button>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>

      // 폼 유효성 검사 함수
      function validateForm() {
        var rating = document.querySelector('input[name="star"]:checked'); // 선택된 별점 가져오기
        var comments = document.getElementById("comments").value.trim(); // 입력된 리뷰 내용 가져오기
        var reviewno = document.getElementById("reviewno").value;
        if (!rating) { // 별점이 선택되지 않은 경우
          showModal("별점을 넣어주세요."); // 경고 모달창 표시
          return false; // 폼 제출 중단
        }

        if (comments === "") { // 리뷰 내용이 입력되지 않은 경우
          showModal("리뷰를 남겨주세요."); // 경고 모달창 표시
          return false; // 폼 제출 중단
        }

        //  6월6일
        document.forms['frm'].submit(); // 폼 제출
        
        showModal("등록이 완료되었습니다.");
          
        fetch("http://127.0.0.1:5000/update_emotion", {
          method: "post",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ comments, reviewno })
        })
        .then(response => response.json())
        .then(data => {
        alert(2)
        let res = data['res']; // flask에서  1이면 긍정 0이면 부정의 값을 받아 res에 저장
        let word = data['word']; // 긍부정 단어 
        let keywordname= data['keywordname']; // 핵심 키워드       
        })
        .catch(error => {
        // 에러 발생 시 경고 모달창 표시
        showModal("서버 요청에 실패했습니다. 나중에 다시 시도해주세요.");
        console.error("Error:", error);
      });
      
      
        return true; // 폼 제출 허용
      }

      // 경고 모달창 표시 함수
      function showModal(message) {
        document.getElementById("modalBody").innerText = message; // 모달창 내용 설정
        $('#warningModal').modal('show'); // 모달창 표시
      }

      // 리뷰 작성 폼으로 포커스 이동 함수
      function focusForm() {
        document.getElementById("comments").focus(); // 리뷰 작성 폼으로 포커스 이동
      }

    </script>
    <!-- /cate/list_all_component.html 파일의 list_all_fragment import -->
    <div th:replace="~{comments/comm_list::comment_list_fragment}"></div>
  </div>
</div>

</html>